# Google Classroom 新着通知 (Discord連携)

この Google Apps Script (GAS) は、Google Classroom の新しいお知らせと課題を検出し、指定した Discord チャンネルに通知するスクリプトです。

## 概要

このスクリプトは以下の機能を持ちます。

* **新しいお知らせの通知**: Google Classroom のコースで新しいお知らせが投稿されると、投稿者名、本文、添付ファイルへのリンクと共に Discord に通知します。
* **新しい課題の通知**: Google Classroom のコースで新しい課題が投稿されると、課題名、説明、提出期限、配点、関連資料へのリンクと共に Discord に通知します。
* **既読管理**: 過去に処理したお知らせや課題は再度通知しません。
* **コース除外設定**: 特定のコースからの通知を無視するように設定できます。
* **添付ファイルのサポート**: お知らせと課題に添付された Google ドライブファイル、リンク、YouTube 動画へのリンクを通知に含めます。

## セットアップ手順

1.  **Google Apps Script エディタを開く**: Google Classroom を利用している Google アカウントで Google ドライブを開き、「新規」 > 「その他」 > 「Google Apps Script」を選択して、新しいスクリプトファイルを作成します。
2.  **スクリプトをコピー＆ペースト**: この `README.md` に記載されている GAS のコード（`// =========================================================================` から始まる部分）を、作成したスクリプトエディタにコピー＆ペーストします。既存のコードはすべて削除してください。
3.  **設定**: スクリプト内の設定項目を編集します。
    * `WEBHOOK_URL`: 通知を送信したい Discord チャンネルの Webhook URL を入力します。Discord チャンネルの設定で Webhook を作成し、その URL をここに貼り付けてください。
    * `EXCLUDED_COURSE_IDS`: 通知を**除外**したい Google Classroom のコース ID のリストを入力します。複数のコース ID を指定する場合は、カンマで区切ってください。コース ID は、Google Classroom のコースを開いた際の URL (`https://classroom.google.com/c/xxxxxxxxxx`) の `xxxxxxxxxx` の部分です。
4.  **Google Classroom API の有効化**:
    * スクリプトエディタの左側にある「サービス」の横の `+` アイコンをクリックします。
    * サービスを追加... のダイアログで「Classroom」を検索し選択します。
    * バージョンは最新のものを選択し、「追加」をクリックします。
    * 承認が求められた場合は、画面の指示に従って承認してください。
5.  **トリガーの設定**:
    * スクリプトエディタの左側にある時計のアイコン（トリガー）をクリックします。
    * 右下の「トリガーを追加」ボタンをクリックします。
    * 次の設定を行います。
        * **実行する関数**: `checkAllMyCoursesAndNotify` を選択します。
        * **イベントソース**: 「時間主導型」を選択します。
        * **時間ベースのトリガーのタイプ**: 通知の頻度に合わせて適切なものを選択します（例: 「分タイマー」で 5 分ごとなど）。
        * **エラー通知**: 必要に応じて設定します。
    * 「保存」をクリックし、承認が求められた場合は画面の指示に従って承認してください。

## GAS 実装の際のポイント

* **API の有効化**: Google Classroom API を使用するためには、スクリプトエディタで明示的にサービスを追加する必要があります（上記手順 4）。
* **権限**: スクリプトの実行には、Google Classroom のコースの閲覧権限、およびスクリプトプロパティへのアクセス権限が必要です。トリガー設定時に承認が求められます。
* **Webhook URL の機密性**: `WEBHOOK_URL` は機密情報ですので、適切に管理してください。スクリプトを公開する場合は特に注意が必要です。
* **スクリプトプロパティ**: 既読管理のために、スクリプトプロパティサービス (`PropertiesService`) を使用しています。お知らせと課題ごとに最終処理日時を保存し、新しいものだけを通知するようにしています。
* **エラーハンドリング**: `try...catch` ブロックを使用して、API の呼び出しや Discord への送信時に発生する可能性のあるエラーを処理しています。エラーが発生した場合は、Cloud Logging (スクリプトエディタの「表示」>「ログ」) に記録されます。
* **非同期処理の考慮**: 大量のコースを処理する場合、処理時間が長くなる可能性があります。時間制限に注意し、必要に応じて処理間隔を調整してください (`Utilities.sleep()`)。
* **Discord の Embed**: Discord のリッチな埋め込み (`embeds`) を使用して、お知らせや課題の内容をわかりやすく表示しています。
* **日付と時刻のフォーマット**: Google API から取得した日付オブジェクトを、`formatDueDate` 関数で読みやすい形式に変換しています。
* **コースの状態**: 非アクティブなコース (`courseState === "ACTIVE"`) はスキップするようにしています。
* **投稿者情報の取得**: お知らせの投稿者の名前を取得するために `Classroom.UserProfiles.get()` を使用していますが、エラーが発生した場合に備えてフォールバック処理を入れています。
* **添付ファイルの処理**: お知らせや課題に添付されたファイルの種類（Drive ファイル、リンク、YouTube 動画）に応じて、適切なタイトルと URL を埋め込みに含めています。
* **除外リスト**: `EXCLUDED_COURSE_IDS` を使用することで、特定のコースからの通知を簡単に除外できます。
* **ユニークなコースの処理**: 教師として参加しているコースと生徒として参加しているコースの両方を取得し、重複を排除して処理しています。
* **送信順序**: 複数のお知らせや課題が同時に更新された場合、更新日時の古い順に Discord へ送信することで、通知の順序を自然に保つようにしています。
* **レート制限**: Discord Webhook にはレート制限があります。大量の通知を短時間に送信すると制限に引っかかる可能性があるため、`Utilities.sleep(500)` を挿入して送信間隔を設けています。

このスクリプトと `README.md` が、あなたの Google Classroom と Discord の連携に役立つことを願っています。
